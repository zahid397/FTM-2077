<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FTM-2077 Voice Console</title>

<style>
body {
    margin: 0;
    background: black;
    color: #0f0;
    font-family: 'Courier New', Courier, monospace;
    overflow: hidden; /* ‡¶∏‡ßç‡¶ï‡ßç‡¶∞‡¶≤‡¶¨‡¶æ‡¶∞ ‡¶≤‡ßÅ‡¶ï‡¶æ‡¶®‡ßã‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø */
}

canvas {
    position: fixed;
    top: 0;
    left: 0;
    z-index: -1;
}

/* ‡¶´‡ßç‡¶≤‡ßá‡¶ï‡ßç‡¶∏‡¶¨‡¶ï‡ßç‡¶∏ ‡¶¶‡¶ø‡ßü‡ßá ‡¶≤‡ßá‡¶Ü‡¶â‡¶ü ‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤ ‡¶∞‡ßá‡¶∏‡¶™‡¶®‡ßç‡¶∏‡¶ø‡¶≠ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶≤‡ßã */
.wrapper {
    display: flex;
    flex-direction: column;
    justify-content: flex-end; /* ‡¶∏‡¶¨ ‡¶®‡¶ø‡¶ö‡ßá ‡¶•‡¶æ‡¶ï‡¶¨‡ßá */
    height: 100vh;
    padding: 20px;
    box-sizing: border-box;
}

.container, .output {
    background: rgba(0, 0, 0, 0.8); /* ‡¶≤‡ßá‡¶ñ‡¶æ‡¶∞ ‡¶®‡¶ø‡¶ö‡ßá ‡¶π‡¶æ‡¶≤‡¶ï‡¶æ ‡¶ï‡¶æ‡¶≤‡ßã ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ï‡¶ó‡ßç‡¶∞‡¶æ‡¶â‡¶®‡ßç‡¶° */
    border: 1px solid #0f0;
    padding: 15px;
    margin-bottom: 10px;
    width: 100%;
    max-width: 500px;
    box-sizing: border-box;
}

.output {
    height: 200px; /* ‡¶Ü‡¶â‡¶ü‡¶™‡ßÅ‡¶ü ‡¶¨‡¶ï‡ßç‡¶∏‡ßá‡¶∞ ‡¶π‡¶æ‡¶á‡¶ü */
    overflow-y: auto;
    font-size: 14px;
    margin-bottom: auto; /* ‡¶Ü‡¶â‡¶ü‡¶™‡ßÅ‡¶ü ‡¶â‡¶™‡¶∞‡ßá ‡¶†‡ßá‡¶≤‡ßá ‡¶¶‡ßá‡¶¨‡ßá */
}

textarea {
    width: 100%;
    height: 60px;
    background: black;
    color: #0f0;
    border: 1px solid #005500;
    padding: 10px;
    box-sizing: border-box;
    font-family: inherit;
    resize: none;
}
textarea:focus { outline: none; border-color: #0f0; }

button {
    margin-top: 10px;
    background: #002200;
    border: 1px solid #0f0;
    color: #0f0;
    padding: 12px;
    cursor: pointer;
    width: 100%;
    font-weight: bold;
    font-family: inherit;
    transition: 0.2s;
}
button:hover { background: #0f0; color: black; }
button:disabled { border-color: gray; color: gray; cursor: not-allowed; }

#playVoiceBtn {
    display: none; /* ‡¶°‡¶ø‡¶´‡¶≤‡ßç‡¶ü‡¶≠‡¶æ‡¶¨‡ßá ‡¶≤‡ßÅ‡¶ï‡¶æ‡¶®‡ßã ‡¶•‡¶æ‡¶ï‡¶¨‡ßá */
    background: #004400;
    border-color: #00ff00;
    box-shadow: 0 0 10px #00ff00;
    animation: pulse 1.5s infinite;
}

@keyframes pulse {
    0% { box-shadow: 0 0 5px #00ff00; }
    50% { box-shadow: 0 0 20px #00ff00; }
    100% { box-shadow: 0 0 5px #00ff00; }
}
</style>
</head>

<body>

<canvas id="matrix"></canvas>

<div class="wrapper">
    <div class="output">
        <h3 style="margin-top:0; border-bottom: 1px dashed #0f0;">MISSION LOG</h3>
        <pre id="missionOutput" style="white-space: pre-wrap;">System Online. Awaiting directive...</pre>
    </div>

    <div class="container">
        <textarea id="missionInput" placeholder="Enter command protocol..."></textarea>
        
        <button id="execBtn" onclick="sendMission()">EXECUTE PROTOCOL</button>
        <button id="playVoiceBtn">üîä AUDIO RECEIVED - TAP TO PLAY</button>
    </div>
</div>

<script>
// ===============================
// CONFIG
// ===============================
const BASE_URL = "https://ftm-2077.onrender.com";
const API_URL = `${BASE_URL}/api`;

let lastAudioUrl = null;
const audioPlayer = new Audio();

// ===============================
// MATRIX BACKGROUND (RESIZABLE)
// ===============================
const canvas = document.getElementById("matrix");
const ctx = canvas.getContext("2d");

let drops = [];
const letters = "01FTM2077Œ©ŒîœÄ";

function resizeCanvas() {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
    
    // ‡¶∞‡¶ø‡¶∏‡¶æ‡¶á‡¶ú ‡¶π‡¶≤‡ßá ‡¶ï‡¶≤‡¶æ‡¶Æ ‡¶∏‡¶Ç‡¶ñ‡ßç‡¶Ø‡¶æ ‡¶™‡ßÅ‡¶®‡¶∞‡¶æ‡ßü ‡¶ó‡¶£‡¶®‡¶æ
    const columns = Math.floor(canvas.width / 20);
    drops = Array(columns).fill(1);
}

// ‡¶â‡¶á‡¶®‡ßç‡¶°‡ßã ‡¶≤‡ßã‡¶° ‡¶è‡¶¨‡¶Ç ‡¶∞‡¶ø‡¶∏‡¶æ‡¶á‡¶ú ‡¶π‡¶≤‡ßá ‡¶ï‡ßç‡¶Ø‡¶æ‡¶®‡¶≠‡¶æ‡¶∏ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶π‡¶¨‡ßá
window.addEventListener('resize', resizeCanvas);
resizeCanvas(); 

function drawMatrix() {
    ctx.fillStyle = "rgba(0,0,0,0.05)"; // ‡¶ü‡ßç‡¶∞‡ßá‡¶á‡¶≤ ‡¶á‡¶´‡ßá‡¶ï‡ßç‡¶ü
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    ctx.fillStyle = "#0f0"; // ‡¶ü‡ßá‡¶ï‡ßç‡¶∏‡¶ü ‡¶ï‡¶æ‡¶≤‡¶æ‡¶∞
    ctx.font = "16px monospace";

    drops.forEach((y, i) => {
        const text = letters[Math.floor(Math.random() * letters.length)];
        ctx.fillText(text, i * 20, y * 20);
        
        // ‡¶∞‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶°‡¶Æ ‡¶∞‡¶ø‡¶∏‡ßá‡¶ü
        if (y * 20 > canvas.height && Math.random() > 0.975) {
            drops[i] = 0;
        }
        drops[i]++;
    });
}
setInterval(drawMatrix, 50);

// ===============================
// CORE LOGIC
// ===============================
async function sendMission() {
    const inputField = document.getElementById("missionInput");
    const outputField = document.getElementById("missionOutput");
    const execBtn = document.getElementById("execBtn");
    const playBtn = document.getElementById("playVoiceBtn");
    
    const text = inputField.value.trim();
    if (!text) return;

    // UI Reset
    outputField.innerText = "Encrypting transmission... Processing...";
    execBtn.disabled = true;
    execBtn.innerText = "UPLOADING...";
    playBtn.style.display = "none";
    audioPlayer.pause();

    try {
        const res = await fetch(`${API_URL}/execute`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                command: text,
                persona: "JARVIS"
            })
        });

        const data = await res.json();
        
        // ‡¶∞‡ßá‡¶ú‡¶æ‡¶≤‡ßç‡¶ü ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®‡ßã
        outputField.innerText = `> RESPONSE RECEIVED:\n\n${JSON.stringify(data, null, 2)}`;

        // ‡¶Ö‡¶°‡¶ø‡¶ì ‡¶≤‡¶ú‡¶ø‡¶ï
        if (data.audio) {
            // URL ‡¶´‡¶ø‡¶ï‡ßç‡¶∏‡¶æ‡¶∞: ‡¶Ø‡¶¶‡¶ø http ‡¶•‡¶æ‡¶ï‡ßá ‡¶≠‡¶æ‡¶≤‡ßã, ‡¶®‡¶æ ‡¶•‡¶æ‡¶ï‡¶≤‡ßá ‡¶¨‡ßá‡¶∏ URL ‡¶Ø‡ßã‡¶ó ‡¶π‡¶¨‡ßá
            lastAudioUrl = data.audio.startsWith("http") 
                ? data.audio 
                : `${BASE_URL}${data.audio}`;
            
            audioPlayer.src = lastAudioUrl;

            // ‡¶Ö‡¶ü‡ßã ‡¶™‡ßç‡¶≤‡ßá ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶ö‡ßá‡¶∑‡ßç‡¶ü‡¶æ (Try Auto-Play)
            audioPlayer.play().catch(error => {
                console.log("Auto-play blocked by browser, showing button.");
                playBtn.style.display = "block"; // ‡¶¨‡ßç‡¶Ø‡¶∞‡ßç‡¶• ‡¶π‡¶≤‡ßá ‡¶¨‡¶æ‡¶ü‡¶® ‡¶¶‡ßá‡¶ñ‡¶æ‡¶¨‡ßá
            });
        }

    } catch (err) {
        outputField.innerText = "‚ùå ERROR: Uplink Failed. Backend unreachable.";
        console.error(err);
    } finally {
        execBtn.disabled = false;
        execBtn.innerText = "EXECUTE PROTOCOL";
    }
}

// ‡¶¨‡¶æ‡¶ü‡¶® ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‡¶π‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶°‡¶≤‡¶æ‡¶∞ (‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ï‡¶Ü‡¶™)
document.getElementById("playVoiceBtn").onclick = () => {
    if (lastAudioUrl) {
        audioPlayer.play();
        document.getElementById("playVoiceBtn").style.display = "none"; // ‡¶™‡ßç‡¶≤‡ßá ‡¶π‡¶≤‡ßá ‡¶¨‡¶æ‡¶ü‡¶® ‡¶π‡¶æ‡¶á‡¶°
    }
};
</script>

</body>
</html>
