<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>FTM-2077 Voice Console</title>

<style>
body {
    margin: 0;
    background: black;
    color: #0f0;
    font-family: monospace;
    overflow: hidden;
}

canvas {
    position: fixed;
    top: 0;
    left: 0;
    z-index: -1;
}

.container {
    position: absolute;
    bottom: 30px;
    left: 20px;
    width: 90%;
    max-width: 420px;
}

textarea {
    width: 100%;
    height: 90px;
    background: black;
    color: #0f0;
    border: 2px solid #0f0;
    padding: 10px;
    box-sizing: border-box;
}

button {
    margin-top: 10px;
    background: black;
    border: 2px solid #0f0;
    color: #0f0;
    padding: 10px;
    cursor: pointer;
    width: 100%;
}

.output {
    position: absolute;
    bottom: 30px;
    right: 20px;
    width: 90%;
    max-width: 420px;
    height: 260px;
    border: 2px solid #0f0;
    padding: 10px;
    overflow-y: auto;
}

#playVoiceBtn {
    display: none;
}
</style>
</head>

<body>

<canvas id="matrix"></canvas>

<div class="container">
    <h3>NEURAL TERMINAL</h3>
    <textarea id="missionInput" placeholder="Enter mission directive..."></textarea>
    <button onclick="sendMission()">EXECUTE</button>
    <button id="playVoiceBtn" onclick="playVoice()">ðŸ”Š PLAY VOICE</button>
</div>

<div class="output" id="scrollBox">
    <h3>MISSION OUTPUT</h3>
    <pre id="missionOutput">Awaiting command...</pre>
</div>

<audio id="voicePlayer"></audio>

<script>
// ===============================
// CONFIG
// ===============================
const API = "https://ftm-2077.onrender.com";

// ===============================
// AUDIO SETUP
// ===============================
const voicePlayer = document.getElementById("voicePlayer");
const playVoiceBtn = document.getElementById("playVoiceBtn");
let audioUnlocked = false;

function unlockAudio() {
    if (audioUnlocked) return;
    audioUnlocked = true;

    const silent =
      "data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAESsAACJWAAACABAAZGF0YQAAAAA=";

    voicePlayer.src = silent;
    voicePlayer.play().then(() => {
        voicePlayer.pause();
        voicePlayer.currentTime = 0;
    }).catch(() => {});
}

document.addEventListener("click", unlockAudio, { once: true });
document.addEventListener("touchstart", unlockAudio, { once: true });

function playVoice() {
    if (!voicePlayer.src) return;
    voicePlayer.currentTime = 0;
    voicePlayer.play();
}

// ===============================
// TYPING EFFECT
// ===============================
function typeText(target, text, speed = 18) {
    return new Promise(resolve => {
        let i = 0;
        function type() {
            if (i < text.length) {
                target.textContent += text[i++];
                target.parentElement.scrollTop =
                    target.parentElement.scrollHeight;
                setTimeout(type, speed);
            } else resolve();
        }
        type();
    });
}

// ===============================
// SEND MISSION
// ===============================
async function sendMission() {
    const input = document.getElementById("missionInput");
    const output = document.getElementById("missionOutput");
    const scrollBox = document.getElementById("scrollBox");

    const text = input.value.trim();
    if (!text) return;

    output.textContent += `\n\n> ${text}\n`;
    input.value = "";

    try {
        const res = await fetch(`${API}/api/execute`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                command: text,
                persona: "JARVIS"
            })
        });

        const data = await res.json();

        await typeText(output, data.text || "[No response]", 18);

        if (data.audio) {
            voicePlayer.src = data.audio.startsWith("http")
                ? data.audio
                : `${API}${data.audio}`;
            playVoiceBtn.style.display = "block";
        }

        scrollBox.scrollTop = scrollBox.scrollHeight;

    } catch (e) {
        output.textContent += "\nâŒ SYSTEM ERROR\n";
    }
}

// ===============================
// ENTER KEY SUPPORT
// ===============================
document.getElementById("missionInput")
  .addEventListener("keydown", e => {
    if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        sendMission();
    }
});

// ===============================
// MATRIX BACKGROUND
// ===============================
const canvas = document.getElementById("matrix");
const ctx = canvas.getContext("2d");

canvas.width = window.innerWidth;
canvas.height = window.innerHeight;

const letters = "01FTM2077Î©Î”";
const drops = Array(Math.floor(canvas.width / 20)).fill(1);

function drawMatrix() {
    ctx.fillStyle = "rgba(0,0,0,0.05)";
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    ctx.fillStyle = "#0f0";
    ctx.font = "15px monospace";

    drops.forEach((y, i) => {
        const text = letters[Math.floor(Math.random() * letters.length)];
        ctx.fillText(text, i * 20, y * 20);

        if (y * 20 > canvas.height && Math.random() > 0.975) {
            drops[i] = 0;
        }
        drops[i]++;
    });
}

setInterval(drawMatrix, 50);
</script>

</body>
</html>
