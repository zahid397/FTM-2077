<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<title>FTM-2077: SYSTEM OVERRIDE</title>

<style>
/* ================= 1. CORE AESTHETICS ================= */
@import url('https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;700&display=swap');

:root {
    --primary: #0f0;
    --secondary: #003300;
    --bg: #050505;
    --alert: #ff3333;
}

body {
    margin: 0;
    background-color: var(--bg);
    color: var(--primary);
    font-family: 'Fira Code', monospace;
    height: 100dvh;
    overflow: hidden;
    display: flex;
    flex-direction: column;
}

/* CRT SCANLINE EFFECT (The Retro Look) */
body::after {
    content: " ";
    display: block;
    position: absolute;
    top: 0; left: 0; bottom: 0; right: 0;
    background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
    z-index: 999;
    background-size: 100% 2px, 3px 100%;
    pointer-events: none;
}

/* BACKGROUND MATRIX */
canvas#matrix { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -2; opacity: 0.15; }

/* ================= 2. BOOT SCREEN (Start Sequence) ================= */
#boot-screen {
    position: fixed; inset: 0; background: black; z-index: 1000;
    padding: 20px; display: flex; flex-direction: column; justify-content: flex-end;
    font-size: 14px; line-height: 1.5;
}
.boot-line { color: var(--primary); }
.boot-btn {
    margin-top: 20px; padding: 15px; border: 2px solid var(--primary);
    background: transparent; color: var(--primary); font-family: inherit;
    font-size: 18px; cursor: pointer; text-transform: uppercase;
    animation: blink 0.5s infinite alternate;
}
.boot-btn:hover { background: var(--primary); color: black; }

/* ================= 3. MAIN INTERFACE (Hidden initially) ================= */
#main-ui { display: none; height: 100%; flex-direction: column; position: relative; z-index: 1; }

/* HUD HEADER */
.hud-top {
    display: flex; justify-content: space-between; padding: 10px;
    border-bottom: 1px solid var(--primary); background: rgba(0,20,0,0.8);
}
.hud-stat { font-size: 12px; }
.hud-val { font-weight: bold; font-size: 14px; }

/* VISUALIZER (Sound Wave) */
#visualizer-container {
    height: 60px; width: 100%; background: rgba(0,0,0,0.5);
    border-bottom: 1px solid var(--secondary); display: flex; align-items: center; justify-content: center;
}
canvas#wave { width: 100%; height: 100%; }

/* OUTPUT LOG */
#output-log {
    flex: 1; padding: 15px; overflow-y: auto; font-size: 14px;
    text-shadow: 0 0 4px var(--primary);
}
.msg { margin-bottom: 12px; border-left: 2px solid transparent; padding-left: 8px; }
.user { border-color: cyan; color: cyan; opacity: 0.9; }
.ai { border-color: var(--primary); color: var(--primary); }
.sys { color: #555; font-size: 12px; }

/* INPUT DECK */
.input-deck {
    padding: 10px; background: black; border-top: 2px solid var(--primary);
    display: flex; flex-direction: column; gap: 10px;
}
.cmd-row { display: flex; gap: 0; border: 1px solid var(--primary); }
.prompt { padding: 12px; background: var(--secondary); color: var(--primary); font-weight: bold; }
input {
    flex: 1; background: transparent; border: none; color: var(--primary);
    font-family: inherit; font-size: 16px; padding: 10px; outline: none;
}
.action-btn {
    width: 100%; padding: 14px; background: var(--primary); color: black;
    border: none; font-weight: bold; font-family: inherit; font-size: 18px;
    text-transform: uppercase; cursor: pointer; letter-spacing: 2px;
}
.action-btn:active { background: white; }

/* ANIMATIONS */
@keyframes blink { from { opacity: 1; } to { opacity: 0.3; } }
@keyframes glitch { 
    0% { transform: translate(0); } 
    20% { transform: translate(-2px, 2px); } 
    40% { transform: translate(-2px, -2px); } 
    60% { transform: translate(2px, 2px); } 
    80% { transform: translate(2px, -2px); } 
    100% { transform: translate(0); }
}
.glitch { animation: glitch 0.3s cubic-bezier(.25, .46, .45, .94) both infinite; }

</style>
</head>
<body>

<div id="boot-screen">
    <div id="boot-log"></div>
    <button id="init-btn" class="boot-btn" style="display:none;" onclick="startSystem()">INITIALIZE SYSTEM [TAP]</button>
</div>

<canvas id="matrix"></canvas>

<div id="main-ui">
    <div class="hud-top">
        <div class="hud-stat">CORE<br><span class="hud-val" id="cpu">42%</span></div>
        <div class="hud-stat">MEM<br><span class="hud-val" id="mem">12TB</span></div>
        <div class="hud-stat">NET<br><span class="hud-val" id="net">SECURE</span></div>
        <div class="hud-stat">OS<br><span class="hud-val">OMEGA</span></div>
    </div>

    <div id="visualizer-container">
        <canvas id="wave"></canvas>
    </div>

    <div id="output-log">
        <div class="msg sys">SYSTEM READY. WAITING FOR INPUT.</div>
    </div>

    <div class="input-deck">
        <div class="cmd-row">
            <div class="prompt">>_</div>
            <input type="text" id="cmd" placeholder="Enter Command..." autocomplete="off">
        </div>
        <button class="action-btn" onclick="run()">EXECUTE</button>
    </div>
</div>

<script>
/* ================= BOOT SEQUENCE ================= */
const bootLog = document.getElementById('boot-log');
const bootTexts = [
    "BIOS CHECK... OK",
    "LOADING KERNEL v2.0.77...",
    "MOUNTING VOLUMES... SUCCESS",
    "CONNECTING TO NEURAL NET...",
    "ENCRYPTING CONNECTION... DONE",
    "SYSTEM READY."
];

let lineIdx = 0;
function runBoot() {
    if(lineIdx < bootTexts.length) {
        const div = document.createElement('div');
        div.className = 'boot-line';
        div.innerText = bootTexts[lineIdx];
        bootLog.appendChild(div);
        lineIdx++;
        setTimeout(runBoot, 200); // Speed of boot lines
    } else {
        document.getElementById('init-btn').style.display = 'block';
    }
}
window.onload = runBoot;

function startSystem() {
    document.getElementById('boot-screen').style.display = 'none';
    document.getElementById('main-ui').style.display = 'flex';
    initAudio(); // Enable Audio Context
    document.getElementById('cmd').focus();
}

/* ================= MATRIX RAIN ================= */
const cvs = document.getElementById('matrix');
const ctx = cvs.getContext('2d');
function resize() { cvs.width = window.innerWidth; cvs.height = window.innerHeight; }
window.addEventListener('resize', resize); resize();
const cols = Math.floor(cvs.width / 20);
const ypos = Array(cols).fill(0);

function matrix() {
    ctx.fillStyle = '#0001'; ctx.fillRect(0, 0, cvs.width, cvs.height);
    ctx.fillStyle = '#0f0'; ctx.font = '14px monospace';
    ypos.forEach((y, i) => {
        const text = String.fromCharCode(Math.random() * 128);
        const x = i * 20;
        ctx.fillText(text, x, y);
        if (y > cvs.height && Math.random() > 0.975) ypos[i] = 0;
        else ypos[i] = y + 20;
    });
}
setInterval(matrix, 50);

/* ================= AUDIO VISUALIZER ================= */
const waveCvs = document.getElementById('wave');
const waveCtx = waveCvs.getContext('2d');
let audioCtx, analyser, dataArray;

function initAudio() {
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    analyser = audioCtx.createAnalyser();
    analyser.fftSize = 64; // Low res for retro look
    dataArray = new Uint8Array(analyser.frequencyBinCount);
    
    // Connect a silent oscillator just to keep context alive
    const osc = audioCtx.createOscillator();
    osc.connect(analyser); // Connect to analyser
    // osc.start(); // Uncomment if you want constant noise, else leave off
    
    drawWave();
}

function drawWave() {
    requestAnimationFrame(drawWave);
    waveCtx.fillStyle = 'rgba(0, 0, 0, 0.2)'; // Fade effect
    waveCtx.fillRect(0, 0, waveCvs.width, waveCvs.height);
    
    if(!analyser) return;

    // Fake visualizer movement based on random if no audio, or use real data
    // Since browser blocks direct audio stream reading easily, we simulate visualizer on "Speak"
    
    const barWidth = (waveCvs.width / 20);
    let x = 0;
    
    for(let i = 0; i < 20; i++) {
        // Simulating activity
        const h = isSpeaking ? Math.random() * waveCvs.height : 5;
        
        waveCtx.fillStyle = `rgb(0, ${h + 100}, 0)`;
        waveCtx.fillRect(x, (waveCvs.height - h)/2, barWidth - 2, h);
        x += barWidth;
    }
}

/* ================= LOGIC & API ================= */
const API = "https://ftm-2077.onrender.com/api/execute";
const log = document.getElementById('output-log');
const inp = document.getElementById('cmd');
let isSpeaking = false;

function scroll() { log.scrollTop = log.scrollHeight; }

function type(text, el) {
    let i = 0;
    function t() {
        if(i < text.length) {
            el.innerHTML += (text[i] === '\n') ? '<br>' : text[i];
            i++; scroll(); setTimeout(t, 20);
        } else {
            isSpeaking = false;
        }
    }
    isSpeaking = true;
    t();
}

function speak(text) {
    window.speechSynthesis.cancel();
    const u = new SpeechSynthesisUtterance(text);
    const v = window.speechSynthesis.getVoices().find(v=>v.name.includes('Male')||v.name.includes('UK'));
    if(v) u.voice = v;
    u.rate = 1.1; u.pitch = 0.9;
    window.speechSynthesis.speak(u);
}

async function run() {
    const cmd = inp.value.trim();
    if(!cmd) return;

    // UI Updates
    log.innerHTML += `<div class="msg user">> ${cmd}</div>`;
    inp.value = ''; scroll();
    
    // Beep Sound
    if(audioCtx) {
        const o = audioCtx.createOscillator();
        const g = audioCtx.createGain();
        o.connect(g); g.connect(audioCtx.destination);
        o.frequency.value = 800; g.gain.value = 0.1;
        o.start(); o.stop(audioCtx.currentTime + 0.1);
    }

    const load = document.createElement('div');
    load.className = 'msg sys';
    load.innerText = '[NEURAL LINK PROCESSING...]';
    log.appendChild(load); scroll();

    try {
        const res = await fetch(API, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({command: cmd, persona: 'JARVIS'})
        });
        const data = await res.json();
        
        log.removeChild(load);
        
        const aiMsg = document.createElement('div');
        aiMsg.className = 'msg ai';
        log.appendChild(aiMsg);
        
        type(data.text, aiMsg);
        speak(data.text);
        
    } catch(e) {
        load.innerText = '[ERROR] SERVER OFFLINE.';
        load.style.color = 'red';
    }
}

// HUD Animation
setInterval(() => {
    document.getElementById('cpu').innerText = Math.floor(Math.random()*30+20) + '%';
    document.getElementById('mem').innerText = (Math.random()*2+10).toFixed(1) + 'TB';
}, 1000);

inp.addEventListener('keypress', e => { if(e.key === 'Enter') run(); });

</script>
</body>
</html>
